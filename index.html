<script>
  // CONFIGURAÇÕES GERAIS
  const WHATSAPP_CONTATO = "554888337779";
  const SHEET_ID = '16FzPEau-EH0E7P13Mq-CFVT0QZceQMLwTUSQ4aZXXf0'; 
  const SHEET_NAME = 'cadastro-produtos';
  const FULL_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${SHEET_NAME}`;

  let produtos = [];

  // BUSCAR DADOS DA PLANILHA
  async function buscarDadosDoSheets() {
    try {
      const response = await fetch(FULL_URL);
      const text = await response.text();
      // Remove o lixo que o Google coloca antes do JSON
      const json = JSON.parse(text.substr(47).slice(0, -2));
      
      const rows = json.table.rows;
      
      // Mapeia as colunas: A (0)=Cat, B (1)=Nome, C (2)=Valor, D (3)=URL
      produtos = rows.map(row => ({
        cat: row.c[0] ? row.c[0].v : 'Sem Categoria',
        nome: row.c[1] ? row.c[1].v : 'Produto sem nome',
        preco: row.c[2] ? parseFloat(row.c[2].v) : 0,
        url: row.c[3] ? row.c[3].v : ''
      }));

      carregar(); 
    } catch (error) {
      console.error("Erro ao carregar:", error);
      document.getElementById('lista').innerHTML = "<p style='text-align:center'>Erro ao carregar os dados da planilha.</p>";
    }
  }

  // RENDERIZAR PRODUTOS NA TELA
  function carregar(filtroCat = 'todos') {
    const lista = document.getElementById('lista');
    const dados = filtroCat === 'todos' ? produtos : produtos.filter(p => p.cat === filtroCat);
    
    lista.innerHTML = dados.map(p => {
      const msgWhats = encodeURIComponent(`Olá Meirelles! Vi no catálogo: ${p.nome} (R$ ${p.preco.toFixed(2).replace('.',',')}). Está disponível?`);
      return `
        <div class="card" data-nome="${p.nome.toLowerCase()}">
          <div class="img-box" onclick="abrirZoom('${p.url}')">
            ${p.url 
              ? `<img src="${p.url}" loading="lazy" onload="this.style.opacity=1" onerror="this.src='https://placehold.co/400x400?text=Imagem+Indisponível'">` 
              : `<div style="text-align:center;color:#94a3b8;"><i class="fa-solid fa-camera fa-2x"></i><br>EM BREVE</div>`}
          </div>
          <div class="info">
            <span class="cat-tag">${p.cat}</span>
            <div class="nome">${p.nome}</div>
            <div class="preco">R$ ${p.preco.toFixed(2).replace('.',',')}</div>
            <a href="https://wa.me/${WHATSAPP_CONTATO}?text=${msgWhats}" target="_blank" class="btn-whats">
              <i class="fa-brands fa-whatsapp"></i> Tenho Interesse
            </a>
          </div>
        </div>
      `;
    }).join('');
  }

  // FUNÇÕES DE INTERAÇÃO
  function abrirZoom(url) {
    if(!url) return;
    document.getElementById('imageModal').style.display = "flex";
    document.getElementById('imgAmpliada').src = url;
  }

  function filtrarCategoria(cat, btn) {
    document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    carregar(cat);
  }

  function buscarTexto() {
    const termo = document.getElementById('filtro').value.toLowerCase();
    document.querySelectorAll('.card').forEach(card => {
      const nome = card.getAttribute('data-nome');
      card.style.display = nome.includes(termo) ? 'flex' : 'none';
    });
  }

  window.onload = () => buscarDadosDoSheets();
</script>
