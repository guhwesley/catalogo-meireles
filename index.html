<script>
  const WHATSAPP_CONTATO = "554888337779";
  const SHEET_ID = '16FzPEau-EH0E7P13Mq-CFVT0QZceQMLwTUSQ4aZXXf0';
  
  // COLE O NÚMERO DO SEU GID AQUI (Exemplo: '12345678')
  const GID = '75482155'; 

  const FULL_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&gid=${GID}`;

  let produtos = [];

  async function buscarDadosDoSheets() {
    try {
      const response = await fetch(FULL_URL);
      const text = await response.text();
      
      // Limpeza para extrair o JSON puro
      const jsonText = text.substring(text.indexOf("{"), text.lastIndexOf("}") + 1);
      const json = JSON.parse(jsonText);
      
      const rows = json.table.rows;
      
      produtos = rows.map(row => {
        const c = row.c;
        return {
          cat: c[0] ? String(c[0].v) : "Geral",
          nome: c[1] ? String(c[1].v) : "",
          preco: c[2] ? parseFloat(String(c[2].v).replace(',', '.')) : 0,
          url: c[3] ? String(c[3].v).trim() : ""
        };
      }).filter(p => p.nome.length > 1 && p.url.startsWith('http'));

      if (produtos.length === 0) throw new Error("Sem dados");
      carregar(); 
    } catch (e) {
      console.error(e);
      document.getElementById('lista').innerHTML = `
        <div style="grid-column: 1/-1; text-align: center; padding: 40px;">
          <p>Erro ao ler a aba <b>cadastro-produtos</b>.</p>
          <small>Verifique se o número GID no código é o mesmo da sua aba.</small>
        </div>`;
    }
  }

  function carregar(filtroCat = 'todos') {
    const lista = document.getElementById('lista');
    const dados = filtroCat === 'todos' ? produtos : produtos.filter(p => p.cat.toLowerCase() === filtroCat.toLowerCase());
    
    lista.innerHTML = dados.map(p => `
      <div class="card" data-nome="${p.nome.toLowerCase()}">
        <div class="img-box" onclick="abrirZoom('${p.url}')">
          <img src="${p.url}" loading="lazy">
        </div>
        <div class="info">
          <span class="cat-tag">${p.cat}</span>
          <div class="nome">${p.nome}</div>
          <div class="preco">R$ ${p.preco.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
          <a href="https://wa.me/${WHATSAPP_CONTATO}?text=Olá! Vi no catálogo: ${p.nome}. Está disponível?" target="_blank" class="btn-whats">
            <i class="fa-brands fa-whatsapp"></i> Tenho Interesse
          </a>
        </div>
      </div>
    `).join('');
  }

  function abrirZoom(url) {
    document.getElementById('imageModal').style.display = "flex";
    document.getElementById('imgAmpliada').src = url;
  }

  function filtrarCategoria(cat, btn) {
    document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    carregar(cat);
  }

  function buscarTexto() {
    const termo = document.getElementById('filtro').value.toLowerCase();
    document.querySelectorAll('.card').forEach(card => {
      card.style.display = card.dataset.nome.includes(termo) ? 'flex' : 'none';
    });
  }

  window.onload = buscarDadosDoSheets;
</script>
